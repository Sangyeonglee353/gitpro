// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“„ README Generator - í”„ë¡œí•„ README ìë™ ìƒì„±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import * as fs from 'fs';
import * as path from 'path';
import { GitProConfig } from '../types';
import { ModuleResult } from './module-runner';

const GITPRO_START = '<!-- GITPRO:START -->';
const GITPRO_END = '<!-- GITPRO:END -->';

/** ëª¨ë“ˆë³„ ì œëª© */
const MODULE_TITLES: Record<string, { icon: string; title: string }> = {
  'trading-card': { icon: 'ğŸƒ', title: 'Dev Trading Card' },
  'code-dna': { icon: 'ğŸ§¬', title: 'Code DNA' },
  chronicle: { icon: 'ğŸ“œ', title: 'Dev Chronicle' },
  'code-pet': { icon: 'ğŸ¾', title: 'Code Pet' },
  constellation: { icon: 'ğŸŒŒ', title: 'Commit Constellation' },
  'dev-city': { icon: 'ğŸ™ï¸', title: 'Dev City' },
};

/**
 * README.mdë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
 * GITPRO:START ~ GITPRO:END ì‚¬ì´ì˜ ë‚´ìš©ì„ êµì²´í•©ë‹ˆë‹¤.
 */
export function updateReadme(config: GitProConfig, results: ModuleResult[]): void {
  const readmePath = path.resolve(process.cwd(), 'README.md');

  // ê¸°ì¡´ README ë¡œë“œ ë˜ëŠ” ìƒˆë¡œ ìƒì„±
  let readmeContent: string;
  if (fs.existsSync(readmePath)) {
    readmeContent = fs.readFileSync(readmePath, 'utf-8');
  } else {
    readmeContent = generateNewReadme(config);
  }

  // GITPRO ì„¹ì…˜ ìƒì„±
  const gitproSection = generateGitproSection(config, results);

  // ê¸°ì¡´ GITPRO ì„¹ì…˜ êµì²´ ë˜ëŠ” ì¶”ê°€
  if (readmeContent.includes(GITPRO_START) && readmeContent.includes(GITPRO_END)) {
    const startIdx = readmeContent.indexOf(GITPRO_START);
    const endIdx = readmeContent.indexOf(GITPRO_END) + GITPRO_END.length;
    readmeContent =
      readmeContent.substring(0, startIdx) +
      gitproSection +
      readmeContent.substring(endIdx);
  } else {
    readmeContent += '\n\n' + gitproSection;
  }

  fs.writeFileSync(readmePath, readmeContent, 'utf-8');
  console.log('ğŸ“„ README.md ì—…ë°ì´íŠ¸ ì™„ë£Œ!');
}

/**
 * ìƒˆ README.md ê¸°ë³¸ ë‚´ìš©ì„ ìƒì„±í•©ë‹ˆë‹¤.
 */
function generateNewReadme(config: GitProConfig): string {
  const headerText = config.readme.header.text || `Hello, I'm ${config.username}! ğŸ‘‹`;

  return `# ${headerText}

${GITPRO_START}
${GITPRO_END}
`;
}

/**
 * GITPRO ì„¹ì…˜ ë§ˆí¬ë‹¤ìš´ì„ ìƒì„±í•©ë‹ˆë‹¤.
 */
function generateGitproSection(config: GitProConfig, results: ModuleResult[]): string {
  const layout = config.readme.layout || 'vertical';

  switch (layout) {
    case 'grid':
      return generateGridLayout(results);
    case 'tabs':
      return generateTabsLayout(results);
    case 'vertical':
    default:
      return generateVerticalLayout(results);
  }
}

/**
 * ì„¸ë¡œ ë‚˜ì—´ ë ˆì´ì•„ì›ƒ
 */
function generateVerticalLayout(results: ModuleResult[]): string {
  let markdown = `${GITPRO_START}\n\n<div align="center">\n\n`;

  for (const result of results) {
    const info = MODULE_TITLES[result.id] || { icon: 'ğŸ“¦', title: result.id };
    markdown += `### ${info.icon} ${info.title}\n\n`;
    markdown += `<img src="./output/${result.id}.svg" alt="${info.title}" />\n\n`;
  }

  markdown += `</div>\n\n`;
  markdown += `<p align="center"><sub>ğŸ® Generated by <a href="https://github.com/Sangyeonglee353/gitpro">gitpro</a></sub></p>\n\n`;
  markdown += GITPRO_END;

  return markdown;
}

/**
 * 2ì—´ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ
 */
function generateGridLayout(results: ModuleResult[]): string {
  let markdown = `${GITPRO_START}\n\n<div align="center">\n\n`;

  // 2ê°œì”© ë¬¶ì–´ì„œ í…Œì´ë¸”ë¡œ
  for (let i = 0; i < results.length; i += 2) {
    const left = results[i];
    const right = results[i + 1];
    const leftInfo = MODULE_TITLES[left.id] || { icon: 'ğŸ“¦', title: left.id };

    if (right) {
      const rightInfo = MODULE_TITLES[right.id] || { icon: 'ğŸ“¦', title: right.id };
      markdown += `<table><tr>\n`;
      markdown += `<td align="center">\n\n### ${leftInfo.icon} ${leftInfo.title}\n<img src="./output/${left.id}.svg" width="400" />\n\n</td>\n`;
      markdown += `<td align="center">\n\n### ${rightInfo.icon} ${rightInfo.title}\n<img src="./output/${right.id}.svg" width="400" />\n\n</td>\n`;
      markdown += `</tr></table>\n\n`;
    } else {
      markdown += `### ${leftInfo.icon} ${leftInfo.title}\n\n`;
      markdown += `<img src="./output/${left.id}.svg" />\n\n`;
    }
  }

  markdown += `</div>\n\n`;
  markdown += `<p align="center"><sub>ğŸ® Generated by <a href="https://github.com/Sangyeonglee353/gitpro">gitpro</a></sub></p>\n\n`;
  markdown += GITPRO_END;

  return markdown;
}

/**
 * íƒ­(ì ‘ê¸°) ë ˆì´ì•„ì›ƒ
 */
function generateTabsLayout(results: ModuleResult[]): string {
  let markdown = `${GITPRO_START}\n\n<div align="center">\n\n`;

  for (let i = 0; i < results.length; i++) {
    const result = results[i];
    const info = MODULE_TITLES[result.id] || { icon: 'ğŸ“¦', title: result.id };
    const isOpen = i === 0 ? ' open' : '';

    markdown += `<details${isOpen}>\n`;
    markdown += `<summary>${info.icon} ${info.title}</summary>\n\n`;
    markdown += `<img src="./output/${result.id}.svg" alt="${info.title}" />\n\n`;
    markdown += `</details>\n\n`;
  }

  markdown += `</div>\n\n`;
  markdown += `<p align="center"><sub>ğŸ® Generated by <a href="https://github.com/Sangyeonglee353/gitpro">gitpro</a></sub></p>\n\n`;
  markdown += GITPRO_END;

  return markdown;
}
