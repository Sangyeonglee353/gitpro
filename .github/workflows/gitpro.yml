# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸŽ® gitpro - GitHub Profile Suite
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6ì‹œê°„ë§ˆë‹¤ ìžë™ìœ¼ë¡œ í”„ë¡œí•„ ì‹œê°í™”ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
# ìˆ˜ë™ ì‹¤í–‰(workflow_dispatch)ë„ ì§€ì›í•©ë‹ˆë‹¤.

name: ðŸŽ® gitpro - Update Profile

on:
  # 6ì‹œê°„ë§ˆë‹¤ ìžë™ ì‹¤í–‰
  schedule:
    - cron: '0 */6 * * *'

  # ìˆ˜ë™ ì‹¤í–‰ (ìž…ë ¥ íŒŒë¼ë¯¸í„° í¬í•¨)
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'ì „ì²´ ëª¨ë“ˆ ê°•ì œ ìž¬ìƒì„±'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      debug_mode:
        description: 'ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

  # ì„¤ì • íŒŒì¼ ë³€ê²½ ì‹œ ìžë™ ì‹¤í–‰
  push:
    branches: [main]
    paths:
      - 'gitpro.config.yml'
      - 'src/**'

jobs:
  generate:
    runs-on: ubuntu-latest
    name: ðŸŽ® Generate Profile Visualizations
    timeout-minutes: 10

    permissions:
      contents: write

    steps:
      # 1. ë ˆí¬ ì²´í¬ì•„ì›ƒ
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Node.js í™˜ê²½ ì„¤ì • + npm ìºì‹±
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. ì˜ì¡´ì„± ìºì‹œ ë³µì›
      - name: ðŸ“¦ Cache dependencies
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 4. ì˜ì¡´ì„± ì„¤ì¹˜ (ìºì‹œ ë¯¸ìŠ¤ ì‹œì—ë§Œ)
      - name: ðŸ“¦ Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      # 5. TypeScript ë¹Œë“œ ìºì‹œ
      - name: ðŸ”¨ Cache build output
        uses: actions/cache@v4
        id: build-cache
        with:
          path: dist
          key: ${{ runner.os }}-build-${{ hashFiles('src/**/*.ts', 'tsconfig.json') }}
          restore-keys: |
            ${{ runner.os }}-build-

      # 6. TypeScript ë¹Œë“œ (ìºì‹œ ë¯¸ìŠ¤ ì‹œì—ë§Œ)
      - name: ðŸ”¨ Build
        if: steps.build-cache.outputs.cache-hit != 'true' || github.event.inputs.force_rebuild == 'true'
        run: npm run build

      # 7. gitpro ì‹¤í–‰
      - name: ðŸŽ® Run gitpro
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITPRO_DEBUG: ${{ github.event.inputs.debug_mode || 'false' }}
          GITPRO_FORCE: ${{ github.event.inputs.force_rebuild || 'false' }}
        run: npm start

      # 8. ìƒì„±ëœ íŒŒì¼ í™•ì¸
      - name: ðŸ“Š Check generated files
        run: |
          echo "ðŸ“¦ ìƒì„±ëœ SVG íŒŒì¼:"
          ls -la output/ 2>/dev/null || echo "  (output ë””ë ‰í† ë¦¬ ì—†ìŒ)"
          echo ""
          echo "ðŸ’¾ ìƒíƒœ íŒŒì¼:"
          ls -la state/ 2>/dev/null || echo "  (state ë””ë ‰í† ë¦¬ ì—†ìŒ)"
          echo ""
          echo "ðŸ“„ README.md:"
          head -20 README.md 2>/dev/null || echo "  (README.md ì—†ìŒ)"

      # 9. ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ë””ë²„ê·¸ ëª¨ë“œ ì‹œ)
      - name: ðŸ“¤ Upload artifacts (debug)
        if: github.event.inputs.debug_mode == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: gitpro-output
          path: |
            output/
            state/
          retention-days: 7

      # 10. ë³€ê²½ì‚¬í•­ ì»¤ë°‹ & í‘¸ì‹œ
      - name: ðŸ“¤ Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A output/ state/ README.md
          
          # ë³€ê²½ì‚¬í•­ì´ ìžˆì„ ë•Œë§Œ ì»¤ë°‹
          if git diff --staged --quiet; then
            echo "âœ… ë³€ê²½ì‚¬í•­ ì—†ìŒ â€” ì»¤ë°‹ ê±´ë„ˆëœ€"
          else
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M')
            git commit -m "ðŸŽ® gitpro: Update profile visualizations ($TIMESTAMP)"
            git push
            echo "âœ… ë³€ê²½ì‚¬í•­ ì»¤ë°‹ & í‘¸ì‹œ ì™„ë£Œ!"
          fi

      # 11. ì‹¤í–‰ ìš”ì•½
      - name: ðŸ“‹ Job Summary
        if: always()
        run: |
          echo "## ðŸŽ® gitpro ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ• ì‹¤í–‰ ì‹œê°„ | $(date +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ ë¹Œë“œ ìºì‹œ | ${{ steps.build-cache.outputs.cache-hit == 'true' && 'âœ… Hit' || 'âŒ Miss' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ npm ìºì‹œ | ${{ steps.npm-cache.outputs.cache-hit == 'true' && 'âœ… Hit' || 'âŒ Miss' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ ê°•ì œ ìž¬ë¹Œë“œ | ${{ github.event.inputs.force_rebuild || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "output" ]; then
            echo "### ðŸ“¦ ìƒì„±ëœ íŒŒì¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -la output/ >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
